name: full-ci

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  fusion-sweep:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        fusion: [early, late, hybrid]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"
          activate-environment: "true"
      - name: Sync dependencies
        run: uv sync
      - name: Train ${{ matrix.fusion }} fusion
        env:
          HYDRA_FULL_ERROR: "1"
        run: |
          uv run python src/train.py \
            model.fusion_type=${{ matrix.fusion }} \
            training.max_epochs=15 \
            experiment.name=a2_${{ matrix.fusion }}_pamap2
      - name: Evaluate ${ { matrix.fusion } } fusion
        env:
          FUSION: ${{ matrix.fusion }}
        run: |
          set -euo pipefail
          export RESULTS_FILE="runs/a2_${FUSION}_pamap2/results.json"
          BEST_CKPT=$(python - <<'PY'
          import json, os
          from pathlib import Path
          results = Path(os.environ["RESULTS_FILE"])
          data = json.load(results.open())
          print(data["best_model_path"])
          PY
          )
          OUT_DIR="experiments/${FUSION}"
          mkdir -p "${OUT_DIR}"
          uv run python src/eval.py --checkpoint "${BEST_CKPT}" --output_dir "${OUT_DIR}" --device cpu --missing_modality_test --analysis_dir analysis/${FUSION}
      - name: Generate analysis plots
        run: |
          uv run python src/analysis.py --experiment_dir experiments --output_dir analysis
      - name: Upload fusion artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fusion-${{ matrix.fusion }}
          path: |
            runs/a2_${{ matrix.fusion }}_pamap2
            experiments/${{ matrix.fusion }}
            analysis/${{ matrix.fusion }}

  heads-ablation:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        heads: [1, 4, 8]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"
          activate-environment: "true"
      - run: uv sync
      - name: Train num_heads=${{ matrix.heads }}
        env:
          HYDRA_FULL_ERROR: "1"
        run: |
          uv run python src/train.py \
            model.fusion_type=hybrid \
            model.num_heads=${{ matrix.heads }} \
            training.max_epochs=15 \
            experiment.name=a2_hybrid_heads${{ matrix.heads }}
      - name: Evaluate num_heads=${{ matrix.heads }}
        env:
          HEADS: ${{ matrix.heads }}
        run: |
          set -euo pipefail
          export RESULTS_FILE="runs/a2_hybrid_heads${HEADS}/results.json"
          CKPT=$(python - <<'PY'
          import json, os
          from pathlib import Path
          results = Path(os.environ["RESULTS_FILE"])
          data = json.load(results.open())
          print(data["best_model_path"])
          PY
          )
          OUT_DIR="experiments/heads_${HEADS}"
          mkdir -p "${OUT_DIR}"
          uv run python src/eval.py --checkpoint "${CKPT}" --output_dir "${OUT_DIR}" --device cpu --analysis_dir analysis_heads
      - run: uv run python src/analysis.py --experiment_dir experiments --output_dir analysis_heads
      - uses: actions/upload-artifact@v4
        with:
          name: heads-${{ matrix.heads }}
          path: |
            runs/a2_hybrid_heads${{ matrix.heads }}
            experiments/heads_${{ matrix.heads }}
            analysis_heads

  chunks-ablation:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chunk: [256, 512, 1024]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"
          activate-environment: "true"
      - run: uv sync
      - name: Train chunk=${{ matrix.chunk }}
        env:
          HYDRA_FULL_ERROR: "1"
        run: |
          uv run python src/train.py \
            model.fusion_type=hybrid \
            dataset.chunk_size=${{ matrix.chunk }} \
            training.max_epochs=15 \
            experiment.name=a2_hybrid_chunk${{ matrix.chunk }}
      - name: Evaluate chunk=${{ matrix.chunk }}
        env:
          CHUNK: ${{ matrix.chunk }}
        run: |
          set -euo pipefail
          export RESULTS_FILE="runs/a2_hybrid_chunk${CHUNK}/results.json"
          CKPT=$(python - <<'PY'
          import json, os
          from pathlib import Path
          results = Path(os.environ["RESULTS_FILE"])
          data = json.load(results.open())
          print(data["best_model_path"])
          PY
          )
          OUT_DIR="experiments/chunk_${CHUNK}"
          mkdir -p "${OUT_DIR}"
          uv run python src/eval.py --checkpoint "${CKPT}" --output_dir "${OUT_DIR}" --device cpu --analysis_dir analysis_chunk
      - run: uv run python src/analysis.py --experiment_dir experiments --output_dir analysis_chunk
      - uses: actions/upload-artifact@v4
        with:
          name: chunk-${{ matrix.chunk }}
          path: |
            runs/a2_hybrid_chunk${{ matrix.chunk }}
            experiments/chunk_${{ matrix.chunk }}
            analysis_chunk

  single-modality-sweep:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        modality: [imu_hand, imu_chest, imu_ankle, heart_rate]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"
          activate-environment: "true"
      - run: uv sync
      - name: Train single-modality ${{ matrix.modality }}
        env:
          HYDRA_FULL_ERROR: "1"
        run: |
          uv run python src/train.py \
            model.fusion_type=early \
            dataset.modalities=[${{ matrix.modality }}] \
            training.max_epochs=10 \
            experiment.name=a2_single_${{ matrix.modality }}
      - name: Evaluate single-modality ${{ matrix.modality }}
        env:
          MOD: ${{ matrix.modality }}
        run: |
          set -euo pipefail
          export RESULTS_FILE="runs/a2_single_${MOD}/results.json"
          CKPT=$(python - <<'PY'
          import json, os
          from pathlib import Path
          results = Path(os.environ["RESULTS_FILE"])
          data = json.load(results.open())
          print(data["best_model_path"])
          PY
          )
          OUT_DIR="experiments/single_${MOD}"
          mkdir -p "${OUT_DIR}"
          uv run python src/eval.py --checkpoint "${CKPT}" --output_dir "${OUT_DIR}" --device cpu --analysis_dir analysis_single
      - run: uv run python src/analysis.py --experiment_dir experiments --output_dir analysis_single
      - uses: actions/upload-artifact@v4
        with:
          name: single-${{ matrix.modality }}
          path: |
            runs/a2_single_${{ matrix.modality }}
            experiments/single_${{ matrix.modality }}
            analysis_single

  merge:
    runs-on: ubuntu-latest
    needs:
      - fusion-sweep
      - heads-ablation
      - chunks-ablation
      - single-modality-sweep
    concurrency:
      group: artifact-push-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*"
          merge-multiple: true
      - name: Aggregate fusion metrics
        run: |
          set -euo pipefail
          python - <<'PY'
          from pathlib import Path
          import json
          
          base = Path("experiments")
          results = {"results": {}}
          for fusion_dir in sorted(base.iterdir()):
              eval_file = fusion_dir / "evaluation_results.json"
              if eval_file.exists():
                  results["results"][fusion_dir.name] = json.load(eval_file.open())
          
          (base / "fusion_comparison.json").write_text(json.dumps(results, indent=2))
          PY
      - name: Commit artifacts
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout "${{ github.head_ref || github.ref_name }}"
          git pull --ff-only origin "${{ github.head_ref || github.ref_name }}"
          git add runs
          git add experiments
          git add analysis
          git add analysis_heads
          git add analysis_chunk
          git add analysis_single
          git commit -m "ci: merge artifacts" || echo "No changes to commit"
          git push origin "${{ github.head_ref || github.ref_name }}"
